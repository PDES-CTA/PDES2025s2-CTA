name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_REGISTRY: docker.io
  BACKEND_IMAGE_NAME: francomm/cta-backend
  FRONTEND_IMAGE_NAME: francomm/cta-frontend
  MAJOR_VERSION: 1
  MINOR_VERSION: 0

jobs:
  frontend-checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ESLint - Block PR if fails
      working-directory: ./frontend
      run: npm run lint

    - name: Check for console.logs - Block PR if fails
      working-directory: ./frontend
      run: |
        if grep -r "console\.log" src/; then
          echo "Error: console.log found in source code"
          echo "Please remove all console.log statements before merging"
          exit 1
        else
          echo "No console.log found"
        fi

    - name: npm audit - Block PR if fails
      working-directory: ./frontend
      run: npm audit --audit-level=moderate

  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner - Block PR if fails
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21 (Backend)
      if: matrix.component == 'backend'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Run backend tests
      if: matrix.component == 'backend'
      working-directory: ./backend
      run: ./gradlew test --info
      continue-on-error: ${{ github.base_ref == 'develop' }}

    - name: Backend code coverage
      if: matrix.component == 'backend'
      working-directory: ./backend
      run: ./gradlew jacocoTestReport
      continue-on-error: true

    - name: Set up Node.js (Frontend)
      if: matrix.component == 'frontend'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: Install frontend dependencies
      if: matrix.component == 'frontend'
      working-directory: ./frontend
      run: npm ci

    - name: Run frontend tests
      if: matrix.component == 'frontend'
      working-directory: ./frontend
      run: npm test -- --run --coverage
      continue-on-error: ${{ github.base_ref == 'develop' }}

    - name: Upload test coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ matrix.component }}
        path: ./${{ matrix.component }}/coverage/

    - name: Upload coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        files: ./${{ matrix.component }}/coverage/lcov.info
        flags: ${{ matrix.component }}
        name: ${{ matrix.component }}-coverage
      continue-on-error: true

  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Calculate version
      id: version
      run: |
        MAJOR="${{ env.MAJOR_VERSION }}"
        MINOR="${{ env.MINOR_VERSION }}"
        PATCH="${{ github.run_number }}"
        VERSION="${MAJOR}.${MINOR}.${PATCH}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"

    - name: Generate backend tags
      id: meta-backend
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        IMAGE="${{ env.BACKEND_IMAGE_NAME }}"
        TAGS="${IMAGE}:${VERSION}"
        TAGS="${TAGS},${IMAGE}:latest"
        TAGS="${TAGS},${IMAGE}:main"
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "Backend tags: ${TAGS}"

    - name: Generate frontend tags
      id: meta-frontend
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        IMAGE="${{ env.FRONTEND_IMAGE_NAME }}"
        TAGS="${IMAGE}:${VERSION}"
        TAGS="${TAGS},${IMAGE}:latest"
        TAGS="${TAGS},${IMAGE}:main"
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "Frontend tags: ${TAGS}"

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: |
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: |
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  summary:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Create deployment summary
      run: |
        MAJOR="${{ env.MAJOR_VERSION }}"
        MINOR="${{ env.MINOR_VERSION }}"
        PATCH="${{ github.run_number }}"
        VERSION="${MAJOR}.${MINOR}.${PATCH}"
        
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Version: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
        echo "### Build Number: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quality Checks Passed:" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint validation" >> $GITHUB_STEP_SUMMARY
        echo "- No console.log in production code" >> $GITHUB_STEP_SUMMARY
        echo "- Security vulnerabilities scanned" >> $GITHUB_STEP_SUMMARY
        echo "- Unit & Integration tests passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Images Published:" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: \`${{ env.BACKEND_IMAGE_NAME }}:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: \`${{ env.FRONTEND_IMAGE_NAME }}:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Start:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker compose pull && docker compose up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
