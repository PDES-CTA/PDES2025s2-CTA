name: Quality Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  frontend-quality:
    name: Frontend Checks & Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    # === LINTING & CHECKS ===
    - name: Run ESLint
      working-directory: ./frontend
      run: npm run lint

    - name: Check for console.logs
      working-directory: ./frontend
      run: |
        if grep -r "console\.log" src/; then
          echo "Error: console.log found in source code"
          echo "Please remove all console.log statements before merging"
          exit 1
        else
          echo "No console.log found"
        fi

    - name: Run npm audit
      working-directory: ./frontend
      run: npm audit --audit-level=moderate

    # === TESTS & COVERAGE ===
    - name: Run frontend tests with coverage
      working-directory: ./frontend
      run: npm run test:coverage

    - name: Verify frontend coverage report
      run: |
        if [ -f frontend/coverage/lcov.info ]; then
          echo "Frontend coverage report found"
        else
          echo "Frontend coverage report not found"
          exit 1
        fi

    # === SONARCLOUD ===
    - name: Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar-frontend
        restore-keys: ${{ runner.os }}-sonar-frontend

    - name: SonarCloud Frontend Scan
      uses: SonarSource/sonarqube-scan-action@v5.0.0
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        projectBaseDir: ./frontend
        args: >
          -Dsonar.host.url=https://sonarcloud.io

  backend-quality:
    name: Backend Checks & Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'corretto'
        java-version: '21'
        cache: 'gradle'

    - name: Make gradlew executable
      working-directory: ./backend
      run: chmod +x gradlew

    # === BUILD, TEST & COVERAGE ===
    - name: Build and test backend with coverage
      working-directory: ./backend
      run: ./gradlew build jacocoTestReport --parallel --info

    - name: Verify backend coverage report
      run: |
        if [ -f backend/coverage/jacoco.xml ]; then
          echo "Backend coverage report found"
        else
          echo "Backend coverage report not found"
          exit 1
        fi

    # === SONARCLOUD ===
    - name: Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar-backend
        restore-keys: ${{ runner.os }}-sonar-backend

    - name: SonarCloud Backend Scan
      uses: SonarSource/sonarqube-scan-action@v5.0.0
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        projectBaseDir: ./backend
        args: >
          -Dsonar.host.url=https://sonarcloud.io

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          frontend/package.json
          frontend/package-lock.json
          backend/build.gradle.kts
          backend/settings.gradle.kts
          Dockerfile
          docker-compose.yml
        sparse-checkout-cone-mode: false

    - name: Run Trivy vulnerability scanner (dependencies only)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
        scanners: 'vuln,misconfig'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  checks-summary:
    name: Quality Gates Summary
    needs: [frontend-quality, backend-quality, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check all jobs status
      run: |
        echo "## Quality Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend Quality & Analysis: **${{ needs.frontend-quality.result }}**" >> $GITHUB_STEP_SUMMARY
        echo "- Backend Quality & Analysis: **${{ needs.backend-quality.result }}**" >> $GITHUB_STEP_SUMMARY
        echo "- Security Vulnerability Scan: **${{ needs.security-scan.result }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if any critical job failed
        FAILED=false
        
        if [ "${{ needs.frontend-quality.result }}" != "success" ]; then
          echo " **Frontend quality checks failed**" >> $GITHUB_STEP_SUMMARY
          FAILED=true
        fi
        
        if [ "${{ needs.backend-quality.result }}" != "success" ]; then
          echo " **Backend quality checks failed**" >> $GITHUB_STEP_SUMMARY
          FAILED=true
        fi
        
        if [ "${{ needs.security-scan.result }}" != "success" ]; then
          echo " **Security scan failed**" >> $GITHUB_STEP_SUMMARY
          FAILED=true
        fi
        
        if [ "$FAILED" = true ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality gates not met!" >> $GITHUB_STEP_SUMMARY
          echo "Please fix the issues above before merging." >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "### All quality checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "Code meets quality standards. Ready to merge" >> $GITHUB_STEP_SUMMARY
        fi